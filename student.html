<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SPELLING BEE - STUDENT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Comfortaa&family=Henny+Penny&display=swap" rel="stylesheet">

<style>
/* === UI SAMA DENGAN GURU (DISINGKAT, PAKAI PUNYAMU) === */
body{margin:0;font-family:Comfortaa;background:#eef6f1}
#top{padding:20px;text-align:center;background:#5fb3a2;color:white}
#startBox{margin:120px auto;width:300px;background:white;padding:20px;border-radius:20px;text-align:center}
input,select,button{width:100%;margin-top:10px;height:44px;border-radius:12px;border:none;font-weight:700}
button{background:#5fb3a2;color:white;cursor:pointer}
.wrapper{display:none;margin-top:20px}
.active{background:#fff3bf}
</style>
</head>

<body>

<div id="top">
  <h1>SPELLING BEE</h1>
</div>

<!-- START -->
<div id="startBox">
  <input id="studentName" placeholder="Student Name">
  <select id="level">
    <option value="level1">Level 1</option>
    <option value="level2">Level 2</option>
    <option value="level3">Level 3</option>
  </select>
  <button onclick="startSession()">START</button>
</div>

<!-- TABLE -->
<div class="wrapper" id="game">
  <table width="100%" id="table"></table>
</div>

<script>
/* ================= KONFIGURASI ================= */
const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/FORM_GURU/formResponse";

/* GANTI entry ID SESUAI FORM */
const FORM_ENTRY = {
  name: "entry.1111111111",
  level: "entry.2222222222",
  score: "entry.3333333333",
  total: "entry.4444444444",
  date: "entry.5555555555"
};

const TOTAL_QUESTIONS = 25;
const audioCtx = new (window.AudioContext||webkitAudioContext)();

/* ================= DATA ================= */
let allQuestions = [];
let questions = [];
let index = 0;
let score = 0;

/* ================= CSV ================= */
async function loadCSV(level){
  const res = await fetch(`data/${level}.csv`);
  const text = await res.text();
  return text.trim().split("\n").slice(1).map(l=>l.split(","));
}

/* ================= UTILS ================= */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function speak(t){
  return new Promise(r=>{
    const u=new SpeechSynthesisUtterance(t);
    u.lang="en-US";
    u.onend=r;
    speechSynthesis.speak(u);
  });
}
function wait(ms){return new Promise(r=>setTimeout(r,ms));}

/* ================= GAME ================= */
async function startSession(){
  const name = studentName.value.trim();
  if(!name){alert("Isi nama");return;}

  audioCtx.resume();

  document.getElementById("startBox").style.display="none";
  document.getElementById("game").style.display="block";

  allQuestions = await loadCSV(level.value);
  questions = shuffle(allQuestions).slice(0,TOTAL_QUESTIONS);

  render();
  playQuestion();
}

function render(){
  table.innerHTML="";
  questions.forEach((q,i)=>{
    const r=table.insertRow();
    r.innerHTML=`<td>${i+1}. ${q[1]}</td>`;
  });
}

async function playQuestion(){
  if(index>=questions.length){
    finish();
    return;
  }

  const row = table.rows[index];
  [...table.rows].forEach(r=>r.classList.remove("active"));
  row.classList.add("active");

  const word = questions[index][1];
  const sentence = questions[index][2];

  await speak(word);
  await wait(400);
  await speak(sentence);
  await wait(400);
  await speak(word);

  score++; // dummy benar
  index++;
  setTimeout(playQuestion,1000);
}

/* ================= FINISH ================= */
function finish(){
  sendResult();
  alert("Selesai!\nScore: "+score+"/"+TOTAL_QUESTIONS);
}

function sendResult(){
  const f = new FormData();
  f.append(FORM_ENTRY.name, studentName.value);
  f.append(FORM_ENTRY.level, level.value);
  f.append(FORM_ENTRY.score, score);
  f.append(FORM_ENTRY.total, TOTAL_QUESTIONS);
  f.append(FORM_ENTRY.date, new Date().toLocaleString());

  fetch(GOOGLE_FORM_URL,{
    method:"POST",
    mode:"no-cors",
    body:f
  });
}
</script>

</body>
</html>
